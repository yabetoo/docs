---
title: Flux de paiement
description: Comprendre le flux de paiement complet de la création à la confirmation.
icon: "arrow-progress"
---

Ce guide explique le flux de paiement complet dans Yabetoo, de la création d'une intention de paiement à la réception de la confirmation via les webhooks.

## Vue d'ensemble

Le flux de paiement Yabetoo suit un processus en deux étapes qui vous donne un contrôle total sur le moment et la manière dont les paiements sont capturés.

```mermaid
sequenceDiagram
    participant Client
    participant Serveur
    participant Yabetoo
    participant MobileMoney

    Client->>Serveur: Initier le paiement
    Serveur->>Yabetoo: Créer Payment Intent
    Yabetoo-->>Serveur: Retourner intent + client_secret
    Serveur->>Yabetoo: Confirmer Payment Intent
    Yabetoo->>MobileMoney: Envoyer demande de paiement
    MobileMoney-->>Client: Notification push (entrer PIN)
    Client->>MobileMoney: Confirmer le paiement
    MobileMoney-->>Yabetoo: Paiement confirmé
    Yabetoo-->>Serveur: Webhook: intent.completed
    Serveur-->>Client: Paiement réussi
```

## Étape 1 : Créer une intention de paiement

Une intention de paiement représente votre intention de collecter un paiement. Elle suit le cycle de vie du paiement et stocke les informations sur la transaction.

```javascript
const response = await fetch(
  "https://pay.sandbox.yabetoopay.com/v1/payment-intents",
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer sk_test_XXXXXXXXXXXXXXXXXXXXXXXX",
    },
    body: JSON.stringify({
      amount: 5000,
      currency: "xaf",
    }),
  }
);

const paymentIntent = await response.json();
// Retourne : { id: "pi_xxx", client_secret: "...", amount: 5000, currency: "xaf" }
```

À cette étape :
- Aucun argent n'a été transféré
- L'intention est au statut `pending`
- Vous avez un `client_secret` pour l'étape suivante

## Étape 2 : Confirmer l'intention de paiement

La confirmation déclenche le paiement réel. Vous fournissez les détails du moyen de paiement du client (informations Mobile Money).

```javascript
const response = await fetch(
  "https://pay.sandbox.yabetoopay.com/v1/payment-intents",
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer sk_test_XXXXXXXXXXXXXXXXXXXXXXXX",
    },
    body: JSON.stringify({
      client_secret: paymentIntent.client_secret,
      first_name: "Jean",
      last_name: "Dupont",
      receipt_email: "jean@exemple.com",
      payment_method_data: {
        type: "momo",
        momo: {
          country: "cg",
          msisdn: "+242066594470",
          operator_name: "mtn",
        },
      },
    }),
  }
);
```

Après la confirmation :
- Le client reçoit une notification push sur son téléphone
- Il entre son code PIN pour autoriser le paiement
- Yabetoo attend la réponse du fournisseur Mobile Money

## Étape 3 : Gérer le résultat

### Réponse synchrone

La requête de confirmation retourne immédiatement avec le statut du paiement :

```json
{
  "intent_id": "pi_9aATHBv8UXuD6H5qrSav",
  "amount": 5000,
  "currency": "xaf",
  "status": "succeeded",
  "captured": true
}
```

### Notification Webhook

Pour plus de fiabilité, écoutez toujours les webhooks. Yabetoo envoie un événement `intent.completed` lorsque le paiement réussit :

```javascript
// Votre endpoint webhook
app.post("/webhook", (req, res) => {
  const event = req.body;

  if (event.type === "intent.completed") {
    const payment = event.data;
    // Mettre à jour votre base de données
    // Envoyer une confirmation au client
  }

  res.status(200).send("OK");
});
```

## Statuts de paiement

| Statut | Description |
|--------|-------------|
| `pending` | Intention de paiement créée, pas encore confirmée |
| `processing` | Le paiement est en cours de traitement par le fournisseur Mobile Money |
| `succeeded` | Paiement effectué avec succès |
| `failed` | Paiement échoué (fonds insuffisants, rejeté, etc.) |

## Bonnes pratiques

1. **Vérifiez toujours les webhooks** - Ne vous fiez pas uniquement à la réponse synchrone
2. **Stockez l'ID de l'intention de paiement** - Liez-le à votre commande pour le suivi
3. **Gérez les échecs gracieusement** - Affichez des messages d'erreur clairs aux utilisateurs
4. **Implémentez l'idempotence** - Prévenez les paiements en double lors des nouvelles tentatives

## Alternative : Sessions de paiement

Pour une intégration plus simple, utilisez les Sessions de paiement. Yabetoo gère l'interface de paiement complète :

```javascript
const session = await fetch("https://buy.api.yabetoopay.com/v1/sessions", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: "Bearer sk_test_XXXXXXXXXXXXXXXXXXXXXXXX",
  },
  body: JSON.stringify({
    total: 5000,
    currency: "xaf",
    accountId: "acct_XXXXXXXX",
    successUrl: "https://votresite.com/success",
    cancelUrl: "https://votresite.com/cancel",
  }),
});

// Redirigez le client vers session.url
```

<Note>
  Pour plus de détails sur chaque étape, consultez la [documentation de l'API Payment Intent](/fr/api-reference/payment-intent/create).
</Note>
